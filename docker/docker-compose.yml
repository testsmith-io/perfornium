# Perfornium Docker Compose
# Quick setup for distributed testing with controller + workers
#
# PORT EXPLANATION:
# - Each worker container runs on port 8080 INSIDE the container
# - We map to different HOST ports (8081, 8082, 8083) for external access
# - When using Docker networking, containers talk to each other using
#   container names + internal port: worker-1:8080, worker-2:8080, etc.

services:
  # Controller - orchestrates tests across workers
  controller:
    image: testsmithio/perfornium-controller:latest
    container_name: perfornium-controller
    volumes:
      - ./tests:/tests:ro
      - ./results:/results
      - ./data:/data:ro
    depends_on:
      worker-1:
        condition: service_healthy
      worker-2:
        condition: service_healthy
      worker-3:
        condition: service_healthy
    networks:
      - perfornium-net
    # Run with: docker compose run controller distributed /tests/my-test.yml --workers worker-1:8080,worker-2:8080,worker-3:8080 --sync-start --report

  # Worker 1 - with browser support
  # Internal port 8080, exposed on host as 8081
  worker-1:
    image: testsmithio/perfornium-worker:latest
    container_name: perfornium-worker-1
    ports:
      - "8081:8080"  # host:container
    networks:
      - perfornium-net
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  # Worker 2 - internal 8080, host 8082
  worker-2:
    image: testsmithio/perfornium-worker:latest
    container_name: perfornium-worker-2
    ports:
      - "8082:8080"
    networks:
      - perfornium-net
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  # Worker 3 - internal 8080, host 8083
  worker-3:
    image: testsmithio/perfornium-worker:latest
    container_name: perfornium-worker-3
    ports:
      - "8083:8080"
    networks:
      - perfornium-net
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

networks:
  perfornium-net:
    driver: bridge

# Usage:
#
# 1. Create directories and add test files:
#    mkdir -p tests results data
#    cp my-test.yml tests/
#
# 2. Start workers:
#    docker compose up -d worker-1 worker-2 worker-3
#
# 3. Run distributed test (controller talks to workers via container names):
#    docker compose run controller distributed /tests/my-test.yml \
#      --workers worker-1:8080,worker-2:8080,worker-3:8080 \
#      --sync-start --report
#
# 4. View results:
#    ls results/
#
# 5. Stop workers:
#    docker compose down
#
# NOTE: The controller uses worker-1:8080 (container name + internal port)
#       NOT localhost:8081 (host mapping) because it's on the same Docker network
