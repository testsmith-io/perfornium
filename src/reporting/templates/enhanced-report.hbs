<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{testName}} - Enhanced Performance Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
        }

        [data-theme="dark"] {
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #fbbf24;
            --error-color: #f87171;
            --background-color: #111827;
            --card-background: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1d4ed8 100%);
            color: white;
            padding: 40px 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        [data-theme="dark"] .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .theme-icon {
            font-size: 1.2rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: var(--card-background);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .metric-success {
            color: var(--success-color);
        }

        .metric-warning {
            color: var(--warning-color);
        }

        .metric-error {
            color: var(--error-color);
        }

        .section {
            background: var(--card-background);
            margin-bottom: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .section-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: #f9fafb;
        }

        [data-theme="dark"] .section-header {
            background: #1f2937;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-content {
            padding: 24px;
        }

        .chart-container {
            margin-bottom: 30px;
            height: 400px;
            position: relative;
        }

        .chart-container.large {
            height: 500px;
        }

        .chart-container.small {
            height: 300px;
        }

        .chart-container canvas {
            max-height: 100%;
        }

        .step-stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.85rem;
        }

        .step-stats-table th,
        .step-stats-table td {
            padding: 8px 6px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .step-stats-table th {
            background: #f9fafb;
            font-weight: 600;
            color: var(--text-primary);
            position: sticky;
            top: 0;
            font-size: 0.75rem;
        }

        [data-theme="dark"] .step-stats-table th {
            background: #1f2937;
        }

        .step-stats-table tr:hover {
            background: #f9fafb;
        }

        [data-theme="dark"] .step-stats-table tr:hover {
            background: #374151;
        }

        /* Error Details Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.85rem;
        }

        .data-table th,
        .data-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: #f9fafb;
            font-weight: 600;
            color: var(--text-primary);
            position: sticky;
            top: 0;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        [data-theme="dark"] .data-table th {
            background: #1f2937;
        }

        .data-table tr:hover {
            background: #fef9f9;
        }

        [data-theme="dark"] .data-table tr:hover {
            background: #374151;
        }

        .data-table .url-cell,
        .data-table .error-cell,
        .data-table .response-body-cell {
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: help;
        }

        .data-table .error-cell {
            color: var(--error-color);
            font-weight: 500;
        }

        .data-table .response-body-cell {
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .chart-container {
                height: 300px;
            }

            .step-stats-table {
                font-size: 0.7rem;
            }

            .step-stats-table th,
            .step-stats-table td {
                padding: 6px 4px;
            }
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .chart-controls {
            margin-bottom: 15px;
        }

        .chart-controls button {
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }

        .chart-controls button:hover {
            background: #1d4ed8;
        }

        /* Enhanced table styles for better readability */
        .step-stats-table td:nth-child(n+5):nth-child(-n+13) {
            text-align: right;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .step-stats-table th:nth-child(n+5):nth-child(-n+13) {
            text-align: right;
        }

        /* Core Web Vitals Styles */
        .vitals-section {
            margin-bottom: 30px;
        }

        .vitals-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .vitals-card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid var(--border-color);
            transition: transform 0.2s ease;
        }

        .vitals-card:hover {
            transform: translateY(-2px);
        }

        .vitals-card h3 {
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .vitals-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .vitals-good {
            border-color: var(--success-color);
        }

        .vitals-good .vitals-value {
            color: var(--success-color);
        }

        .vitals-warning {
            border-color: var(--warning-color);
        }

        .vitals-warning .vitals-value {
            color: var(--warning-color);
        }

        .vitals-poor {
            border-color: var(--error-color);
        }

        .vitals-poor .vitals-value {
            color: var(--error-color);
        }

        .vitals-unknown {
            border-color: var(--text-secondary);
        }

        .vitals-unknown .vitals-value {
            color: var(--text-secondary);
        }

        .vitals-score {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .vitals-score.vitals-good {
            background: #d1fae5;
            color: #065f46;
        }

        .vitals-score.vitals-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .vitals-score.vitals-poor {
            background: #fee2e2;
            color: #991b1b;
        }

        .verification-metrics {
            background: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .verification-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .verification-stat {
            text-align: center;
        }

        .verification-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .verification-stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .vitals-cards {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .vitals-value {
                font-size: 1.5rem;
            }

            .verification-stats {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 10px;
            }
        }

        /* Apdex Score Styles */
        .quality-card {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }

        .quality-card h3 {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .apdex-score {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .apdex-excellent { color: #10b981; }
        .apdex-good { color: #22c55e; }
        .apdex-fair { color: #f59e0b; }
        .apdex-poor { color: #f97316; }
        .apdex-unacceptable { color: #ef4444; }

        .apdex-rating {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .apdex-breakdown {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .apdex-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .apdex-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .apdex-value {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .apdex-value.satisfied { color: #10b981; }
        .apdex-value.tolerating { color: #f59e0b; }
        .apdex-value.frustrated { color: #ef4444; }

        /* SLA Compliance Styles */
        .sla-status {
            font-size: 2rem;
            font-weight: 700;
            padding: 12px 24px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .sla-passed {
            background: #dcfce7;
            color: #166534;
        }

        .sla-failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .sla-summary {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .sla-checks {
            text-align: left;
        }

        .sla-check {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .check-passed {
            background: #f0fdf4;
        }

        .check-failed {
            background: #fef2f2;
        }

        .check-icon {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .check-passed .check-icon { color: #10b981; }
        .check-failed .check-icon { color: #ef4444; }

        .check-name {
            flex: 1;
            font-weight: 500;
        }

        .check-values {
            color: var(--text-secondary);
            font-family: monospace;
        }

        /* Confidence Interval Styles */
        .confidence-section {
            margin-top: 24px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .confidence-section h4 {
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .confidence-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: linear-gradient(to right, #e0f2fe, #bae6fd, #e0f2fe);
            border-radius: 6px;
            font-family: monospace;
        }

        .ci-lower, .ci-upper {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .ci-mean {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        /* Outlier Analysis Styles */
        .outlier-section {
            margin-top: 16px;
            padding: 16px;
            background: #fffbeb;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }

        .outlier-section h4 {
            margin-bottom: 8px;
            color: #92400e;
        }

        .outlier-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.9rem;
        }

        .outlier-count {
            font-weight: 600;
            color: #f59e0b;
        }

        .outlier-percentage {
            color: var(--text-secondary);
        }

        .outlier-bounds {
            color: var(--text-secondary);
            font-family: monospace;
        }

        /* Performance Trend Styles */
        .trend-section {
            margin-top: 16px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .trend-section h4 {
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .trend-indicator {
            font-size: 1.1rem;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 6px;
            display: inline-block;
        }

        .trend-indicator.improving {
            background: #dcfce7;
            color: #166534;
        }

        .trend-indicator.degrading {
            background: #fee2e2;
            color: #991b1b;
        }

        .trend-indicator.stable {
            background: #f0f9ff;
            color: #0369a1;
        }

        .trend-indicator.insufficient_data {
            background: #f3f4f6;
            color: #6b7280;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
                <span class="theme-icon" id="themeIcon">ðŸŒ™</span>
                <span id="themeText">Dark Mode</span>
            </button>
            <h1>{{testName}}</h1>
            <p>Enhanced Performance Test Report â€¢ Generated on {{generatedAt}}</p>
        </div>

        <!-- Summary Metrics -->
        <div class="summary-grid">
            <div class="metric-card">
                <div class="metric-value">{{summary.total_requests}}</div>
                <div class="metric-label">Total Requests</div>
            </div>
            <div class="metric-card">
                <div
                    class="metric-value {{#if (gt summary.success_rate 95)}}metric-success{{else}}{{#if (gt summary.success_rate 90)}}metric-warning{{else}}metric-error{{/if}}{{/if}}">
                    {{toFixed summary.success_rate 2}}%
                </div>
                <div class="metric-label">Success Rate</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{toFixed summary.avg_response_time 2}}ms</div>
                <div class="metric-label">Avg Response Time</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{toFixed summary.requests_per_second 2}}</div>
                <div class="metric-label">Requests/sec</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{#if summary.peak_virtual_users}}{{summary.peak_virtual_users}}{{else}}{{#if summary.total_virtual_users}}{{summary.total_virtual_users}}{{else}}{{summary.vu_ramp_up.length}}{{/if}}{{/if}}</div>
                <div class="metric-label">Virtual Users</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{toFixed summary.total_duration 0}}s</div>
                <div class="metric-label">Total Duration</div>
            </div>
        </div>

        <!-- Apdex Score & SLA Compliance -->
        {{#if apdexScore}}
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Performance Quality</h2>
            </div>
            <div class="section-content">
                <div class="grid-2">
                    <!-- Apdex Score Card -->
                    <div class="quality-card">
                        <h3>Apdex Score</h3>
                        <div class="apdex-score {{#if (gte apdexScore.score 0.94)}}apdex-excellent{{else}}{{#if (gte apdexScore.score 0.85)}}apdex-good{{else}}{{#if (gte apdexScore.score 0.70)}}apdex-fair{{else}}{{#if (gte apdexScore.score 0.50)}}apdex-poor{{else}}apdex-unacceptable{{/if}}{{/if}}{{/if}}{{/if}}">
                            {{toFixed apdexScore.score 3}}
                        </div>
                        <div class="apdex-rating">{{apdexScore.rating}}</div>
                        <div class="apdex-breakdown">
                            <div class="apdex-item">
                                <span class="apdex-label">Satisfied:</span>
                                <span class="apdex-value satisfied">{{apdexScore.satisfied}}</span>
                            </div>
                            <div class="apdex-item">
                                <span class="apdex-label">Tolerating:</span>
                                <span class="apdex-value tolerating">{{apdexScore.tolerating}}</span>
                            </div>
                            <div class="apdex-item">
                                <span class="apdex-label">Frustrated:</span>
                                <span class="apdex-value frustrated">{{apdexScore.frustrated}}</span>
                            </div>
                        </div>
                    </div>

                    <!-- SLA Compliance Card -->
                    {{#if slaCompliance}}
                    <div class="quality-card">
                        <h3>SLA Compliance</h3>
                        <div class="sla-status {{#if slaCompliance.passed}}sla-passed{{else}}sla-failed{{/if}}">
                            {{#if slaCompliance.passed}}PASSED{{else}}FAILED{{/if}}
                        </div>
                        <div class="sla-summary">{{slaCompliance.summary}}</div>
                        <div class="sla-checks">
                            {{#each slaCompliance.checks}}
                            <div class="sla-check {{#if passed}}check-passed{{else}}check-failed{{/if}}">
                                <span class="check-icon">{{#if passed}}âœ“{{else}}âœ—{{/if}}</span>
                                <span class="check-name">{{name}}</span>
                                <span class="check-values">{{actual}}{{unit}} / {{target}}{{unit}}</span>
                            </div>
                            {{/each}}
                        </div>
                    </div>
                    {{/if}}
                </div>

                <!-- Confidence Interval -->
                {{#if confidenceInterval}}
                <div class="confidence-section">
                    <h4>Response Time Confidence Interval (95%)</h4>
                    <div class="confidence-bar">
                        <span class="ci-lower">{{confidenceInterval.lower}}ms</span>
                        <span class="ci-mean">{{confidenceInterval.mean}}ms Â± {{confidenceInterval.marginOfError}}ms</span>
                        <span class="ci-upper">{{confidenceInterval.upper}}ms</span>
                    </div>
                </div>
                {{/if}}

                <!-- Outlier Analysis -->
                {{#if outlierAnalysis}}
                {{#if outlierAnalysis.outlierCount}}
                <div class="outlier-section">
                    <h4>Outlier Analysis</h4>
                    <div class="outlier-summary">
                        <span class="outlier-count">{{outlierAnalysis.outlierCount}} outliers detected</span>
                        <span class="outlier-percentage">({{outlierAnalysis.outlierPercentage}}%)</span>
                        <span class="outlier-bounds">Normal range: {{outlierAnalysis.lowerBound}}ms - {{outlierAnalysis.upperBound}}ms</span>
                    </div>
                </div>
                {{/if}}
                {{/if}}

                <!-- Performance Trend -->
                {{#if performanceTrends}}
                <div class="trend-section">
                    <h4>Performance Trend</h4>
                    <div class="trend-indicator {{performanceTrends.trend}}">
                        {{#ifEquals performanceTrends.trend "improving"}}â†“ Improving{{/ifEquals}}
                        {{#ifEquals performanceTrends.trend "degrading"}}â†‘ Degrading{{/ifEquals}}
                        {{#ifEquals performanceTrends.trend "stable"}}â†’ Stable{{/ifEquals}}
                        {{#ifEquals performanceTrends.trend "insufficient_data"}}â€” Insufficient Data{{/ifEquals}}
                    </div>
                </div>
                {{/if}}
            </div>
        </div>
        {{/if}}

        <!-- NEW: Response Time Distribution -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Response Time Distribution</h2>
            </div>
            <div class="section-content">
                <div class="chart-container">
                    <canvas id="responseTimeDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- NEW: Throughput Charts -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Throughput Analysis</h2>
            </div>
            <div class="section-content">
                <div class="grid-2">
                    <div class="chart-container">
                        <canvas id="requestsPerSecondChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="responsesPerSecondChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- VU Ramp-up Chart -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Virtual User Ramp-up</h2>
            </div>
            <div class="section-content">
                <div class="chart-container">
                    <canvas id="vuRampupChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Network Timing Analysis -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Network Timing Analysis</h2>
            </div>
            <div class="section-content">
                <div class="grid-2">
                    <div class="chart-container">
                        <canvas id="connectTimeChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="latencyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        {{#if errorAnalysis.errorDetails}}
        {{#if errorAnalysis.errorDetails.length}}
        <!-- Error Details Table -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Errors by Sample/Request</h2>
                <div class="section-subtitle">
                    Total Errors: <span class="metric-error">{{errorAnalysis.totalErrors}}</span>
                    ({{errorAnalysis.errorRate}}% of all requests)
                </div>
            </div>
            <div class="section-content">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Sample/Request</th>
                                <th>Method</th>
                                <th>URL</th>
                                <th>Status</th>
                                <th>Error Type</th>
                                <th>Error Count</th>
                                <th>Total Requests</th>
                                <th>Error %</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each errorAnalysis.errorDetails}}
                            <tr>
                                <td><strong>{{sample_name}}</strong></td>
                                <td>{{request_method}}</td>
                                <td class="url-cell" title="{{request_url}}">{{request_url}}</td>
                                <td><span class="status-badge status-error">{{status}}</span></td>
                                <td class="error-cell" title="{{error_type}}">{{error_type}}</td>
                                <td>{{error_count}}</td>
                                <td>{{total_sample_requests}}</td>
                                <td><strong>{{percentage}}%</strong></td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {{/if}}
        {{/if}}

        {{#if summary.web_vitals_data}}
        <!-- Core Web Vitals Section -->
        <div class="section vitals-section">
            <div class="section-header">
                <h2 class="section-title">Core Web Vitals Performance</h2>
                <span class="vitals-score {{vitalsScoreClass summary.vitals_score}}">{{summary.vitals_score}}</span>
            </div>
            <div class="section-content">
                <div class="vitals-cards">
                    {{#if summary.web_vitals_data.lcp}}
                    <div class="vitals-card {{vitalsScoreClass summary.vitals_details.lcp.score}}">
                        <h3>LCP</h3>
                        <div class="vitals-value">{{formatVitalsMetric summary.web_vitals_data.lcp 'lcp'}}</div>
                        <div class="vitals-description">Largest Contentful Paint</div>
                    </div>
                    {{/if}}
                    
                    {{#if summary.web_vitals_data.cls}}
                    <div class="vitals-card {{vitalsScoreClass summary.vitals_details.cls.score}}">
                        <h3>CLS</h3>
                        <div class="vitals-value">{{formatVitalsMetric summary.web_vitals_data.cls 'cls'}}</div>
                        <div class="vitals-description">Cumulative Layout Shift</div>
                    </div>
                    {{/if}}
                    
                    {{#if summary.web_vitals_data.inp}}
                    <div class="vitals-card {{vitalsScoreClass summary.vitals_details.inp.score}}">
                        <h3>INP</h3>
                        <div class="vitals-value">{{formatVitalsMetric summary.web_vitals_data.inp 'inp'}}</div>
                        <div class="vitals-description">Interaction to Next Paint</div>
                    </div>
                    {{/if}}
                    
                    {{#if summary.web_vitals_data.ttfb}}
                    <div class="vitals-card {{vitalsScoreClass summary.vitals_details.ttfb.score}}">
                        <h3>TTFB</h3>
                        <div class="vitals-value">{{formatVitalsMetric summary.web_vitals_data.ttfb 'ttfb'}}</div>
                        <div class="vitals-description">Time to First Byte</div>
                    </div>
                    {{/if}}
                    
                    {{#if summary.web_vitals_data.fcp}}
                    <div class="vitals-card {{vitalsScoreClass summary.vitals_details.fcp.score}}">
                        <h3>FCP</h3>
                        <div class="vitals-value">{{formatVitalsMetric summary.web_vitals_data.fcp 'fcp'}}</div>
                        <div class="vitals-description">First Contentful Paint</div>
                    </div>
                    {{/if}}
                </div>

                <!-- Web Vitals Chart -->
                <div class="chart-container">
                    <canvas id="webVitalsChart"></canvas>
                </div>
            </div>
        </div>
        {{/if}}
        
        {{#if webVitalsCharts}}
        <!-- Enhanced Web Vitals Analysis (Playwright Tests) -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Web Vitals Detailed Analysis</h2>
            </div>
            <div class="section-content">
                <!-- Score Distribution -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>Performance Score Distribution</h3>
                        <div class="chart-container small">
                            <canvas id="webVitalsScoreChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Combined Web Vitals Timeline -->
                <div class="section-header" style="margin-top: 30px;">
                    <h3>Web Vitals Timeline (All Metrics)</h3>
                    <p style="color: #666; font-size: 14px;">Interactive timeline showing LCP, CLS, INP, TTFB, FCP, and FID values across all URLs</p>
                </div>
                <div class="chart-container">
                    <canvas id="webVitalsTimelineChart"></canvas>
                </div>
                
                <!-- Individual Metric Charts -->
                <div class="metrics-grid" style="margin-top: 30px;">
                    <!-- Time Series for Each Metric -->
                    {{#each webVitalsCharts.metrics}}
                    <div class="metric-card">
                        <h3>{{this}} Over Time</h3>
                        <div class="chart-container small">
                            <canvas id="webVitals{{this}}Chart"></canvas>
                        </div>
                    </div>
                    {{/each}}
                </div>
                
                <!-- Percentile Distribution -->
                <div class="section-header" style="margin-top: 30px;">
                    <h3>Web Vitals Percentile Distribution</h3>
                </div>
                <div class="chart-container">
                    <canvas id="webVitalsPercentilesChart"></canvas>
                </div>
                
                <!-- Page-by-Page Analysis -->
                {{#if webVitalsCharts.pageAnalysis}}
                <div class="section-header" style="margin-top: 30px;">
                    <h3>Performance by Page</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Page URL</th>
                                <th>Measurements</th>
                                <th>Avg Score</th>
                                <th>LCP (ms)</th>
                                <th>CLS</th>
                                <th>INP (ms)</th>
                                <th>TTFB (ms)</th>
                                <th>FCP (ms)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each webVitalsCharts.pageAnalysis}}
                            <tr>
                                <td>{{this.url}}</td>
                                <td>{{this.measurements}}</td>
                                <td><span class="{{vitalsScoreClass this.avgScore}}">{{this.avgScore}}</span></td>
                                <td>{{#if this.metrics.lcp}}{{formatVitalsMetric this.metrics.lcp.avg 'lcp'}}{{else}}-{{/if}}</td>
                                <td>{{#if this.metrics.cls}}{{formatVitalsMetric this.metrics.cls.avg 'cls'}}{{else}}-{{/if}}</td>
                                <td>{{#if this.metrics.inp}}{{formatVitalsMetric this.metrics.inp.avg 'inp'}}{{else}}-{{/if}}</td>
                                <td>{{#if this.metrics.ttfb}}{{formatVitalsMetric this.metrics.ttfb.avg 'ttfb'}}{{else}}-{{/if}}</td>
                                <td>{{#if this.metrics.fcp}}{{formatVitalsMetric this.metrics.fcp.avg 'fcp'}}{{else}}-{{/if}}</td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
                {{/if}}
            </div>
        </div>
        {{/if}}

        {{#if summary.verification_metrics}}
        <!-- Verification Metrics Section -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Verification Performance</h2>
            </div>
            <div class="section-content">
                <div class="verification-metrics">
                    <div class="verification-stats">
                        <div class="verification-stat">
                            <div class="verification-stat-value">{{summary.verification_metrics.total_verifications}}</div>
                            <div class="verification-stat-label">Total Verifications</div>
                        </div>
                        <div class="verification-stat">
                            <div class="verification-stat-value">{{percent summary.verification_metrics.success_rate 1}}</div>
                            <div class="verification-stat-label">Success Rate</div>
                        </div>
                        <div class="verification-stat">
                            <div class="verification-stat-value">{{formatVerificationDuration summary.verification_metrics.average_duration}}</div>
                            <div class="verification-stat-label">Avg Duration</div>
                        </div>
                        <div class="verification-stat">
                            <div class="verification-stat-value">{{formatVerificationDuration summary.verification_metrics.p95_duration}}</div>
                            <div class="verification-stat-label">95th Percentile</div>
                        </div>
                    </div>
                    
                    <!-- Verification Performance Chart -->
                    <div class="chart-container" style="margin-top: 20px;">
                        <canvas id="verificationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        {{/if}}

        <!-- Response Time Analysis -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Response Time Analysis</h2>
            </div>
            <div class="section-content">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('timeline')">Timeline</button>
                    <button class="tab" onclick="showTab('by-step')">By Step</button>
                    <button class="tab" onclick="showTab('distribution')">Distribution</button>
                </div>

                <div id="timeline" class="tab-content active">
                    <div class="chart-container large">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>

                <div id="by-step" class="tab-content">
                    <div class="chart-container large">
                        <canvas id="stepResponseTimeChart"></canvas>
                    </div>
                </div>

                <div id="distribution" class="tab-content">
                    <div class="chart-container">
                        <canvas id="responseDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Step Statistics -->
        <div class="section">
            <div class="chart-controls" style="margin-bottom: 15px;">
                <button onclick="resetZoom()" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    Reset Zoom
                </button>
            </div>
            <div class="chart-container">
                <canvas id="stepLinesChart"></canvas>
            </div>
            <div class="section-header">
                <h2 class="section-title">Step Performance Statistics</h2>
            </div>
            <div class="section-content">
                <table class="step-stats-table">
                    <thead>
                        <tr>
                            <th>Step Name</th>
                            <th>Scenario</th>
                            <th>Requests</th>
                            <th>Success Rate</th>
                            <th>Min (ms)</th>
                            <th>Avg (ms)</th>
                            <th>Median (ms)</th>
                            <th>Max (ms)</th>
                            <th>P90</th>
                            <th>P95</th>
                            <th>P99</th>
                            <th>P99.9</th>
                            <th>P99.99</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each stepStatistics}}
                        <tr>
                            <td><strong>{{step_name}}</strong></td>
                            <td>{{scenario}}</td>
                            <td>{{total_requests}}</td>
                            <td>{{toFixed success_rate 1}}%</td>
                            <td>{{toFixed min_response_time 1}}</td>
                            <td>{{toFixed avg_response_time 1}}</td>
                            <td>{{lookup percentiles 50}}</td>
                            <td>{{toFixed max_response_time 1}}</td>
                            <td>{{lookup percentiles 90}}</td>
                            <td>{{lookup percentiles 95}}</td>
                            <td>{{lookup percentiles 99}}</td>
                            <td>{{lookup percentiles 99.9}}</td>
                            <td>{{lookup percentiles 99.99}}</td>
                            <td>
                                <span
                                    class="status-badge {{#if (gt success_rate 95)}}status-success{{else}}{{#if (gt success_rate 90)}}status-warning{{else}}status-error{{/if}}{{/if}}">
                                    {{#if (gt success_rate 95)}}Good{{else}}{{#if (gt success_rate
                                    90)}}Warning{{else}}Error{{/if}}{{/if}}
                                </span>
                            </td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Step Percentiles Comparison -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Step Percentile Comparison</h2>
            </div>
            <div class="section-content">
                <div class="grid-2">
                    <div class="chart-container">
                        <canvas id="stepPercentilesChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="stepThroughputChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Timeline -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Performance Timeline</h2>
            </div>
            <div class="section-content">
                <div class="chart-container large">
                    <canvas id="performanceTimelineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Generated by Perfornium Performance Testing Framework</p>
        </div>
    </div>

    <script>
        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Update button text and icon
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');

            if (newTheme === 'dark') {
                themeIcon.textContent = 'â˜€ï¸';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.textContent = 'ðŸŒ™';
                themeText.textContent = 'Dark Mode';
            }
        }

        // Load theme from localStorage on page load
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;
            html.setAttribute('data-theme', savedTheme);

            // Update button on load
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');

            if (savedTheme === 'dark') {
                themeIcon.textContent = 'â˜€ï¸';
                themeText.textContent = 'Light Mode';
            }
        })();

        // Chart data from server
        const summaryData = {{{ summaryData }}};
        const stepStatistics = {{{ stepStatisticsData }}};
        const vuRampupData = {{{ vuRampupData }}};
        const timelineData = {{{ timelineData }}};
        const responseTimeDistributionData = {{{ responseTimeDistributionData }}};
        const requestsPerSecondData = {{{ requestsPerSecondData }}};
        const responsesPerSecondData = {{{ responsesPerSecondData }}};
        const connectTimeData = {{{ connectTimeData }}};
        const latencyData = {{{ latencyData }}};

        // Tab functionality
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active to clicked tab
            event.target.classList.add('active');
        }

        // NEW: Response Time Distribution Chart
        const responseDistCtx = document.getElementById('responseTimeDistributionChart').getContext('2d');
        new Chart(responseDistCtx, {
            type: 'bar',
            data: {
                labels: responseTimeDistributionData.map(d => d.bucket),
                datasets: [{
                    label: 'Request Count',
                    data: responseTimeDistributionData.map(d => d.count),
                    backgroundColor: 'rgba(37, 99, 235, 0.6)',
                    borderColor: 'rgba(37, 99, 235, 1)',
                    borderWidth: 1
                }, {
                    label: 'Percentage',
                    data: responseTimeDistributionData.map(d => d.percentage),
                    type: 'line',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    yAxisID: 'y1',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Overall Response Time Distribution'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Requests'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Percentage (%)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        min: 0,
                        max: 100
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Response Time Range'
                        }
                    }
                }
            }
        });

        // NEW: Requests Per Second Chart
        const requestsPerSecCtx = document.getElementById('requestsPerSecondChart').getContext('2d');
        new Chart(requestsPerSecCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Total Requests/sec',
                    data: requestsPerSecondData.map(d => ({
                        x: new Date(d.timestamp),
                        y: d.requests_per_second
                    })),
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'Successful Requests/sec',
                    data: requestsPerSecondData.map(d => ({
                        x: new Date(d.timestamp),
                        y: d.successful_requests_per_second
                    })),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Requests Per Second Over Time'
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                second: 'HH:mm:ss'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Requests/Second'
                        }
                    }
                }
            }
        });

        // NEW: Responses Per Second Chart
        const responsesPerSecCtx = document.getElementById('responsesPerSecondChart').getContext('2d');
        new Chart(responsesPerSecCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Successful Responses/sec',
                    data: responsesPerSecondData.map(d => ({
                        x: new Date(d.timestamp),
                        y: d.responses_per_second
                    })),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'Error Responses/sec',
                    data: responsesPerSecondData.map(d => ({
                        x: new Date(d.timestamp),
                        y: d.error_responses_per_second
                    })),
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Responses Per Second Over Time'
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                second: 'HH:mm:ss'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Responses/Second'
                        }
                    }
                }
            }
        });

        // VU Ramp-up Chart - uses vuRampupData for accurate ramp-up visualization
        const vuRampupCtx = document.getElementById('vuRampupChart').getContext('2d');
        new Chart(vuRampupCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Active Virtual Users',
                    data: vuRampupData.map(d => ({
                        x: new Date(d.timestamp),
                        y: d.count
                    })),
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    fill: true,
                    tension: 0.1,
                    stepped: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Virtual User Ramp-up Pattern'
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                second: 'HH:mm:ss'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Active Virtual Users'
                        }
                    }
                }
            }
        });

        // Timeline Chart
        const timelineCtx = document.getElementById('timelineChart').getContext('2d');
        new Chart(timelineCtx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Avg Response Time (ms)',
                        data: timelineData.map(d => ({
                            x: new Date(d.timestamp),
                            y: d.avg_response_time
                        })),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4
                    },
                    {
                        label: 'Success Rate (%)',
                        data: timelineData.map(d => ({
                            x: new Date(d.timestamp),
                            y: d.success_rate
                        })),
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Performance Timeline'
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                second: 'HH:mm:ss'
                            }
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Response Time (ms)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Success Rate (%)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        min: 0,
                        max: 100
                    }
                }
            }
        });

        // Step Response Time Chart
        const stepResponseCtx = document.getElementById('stepResponseTimeChart').getContext('2d');
        new Chart(stepResponseCtx, {
            type: 'bar',
            data: {
                labels: stepStatistics.map(s => s.step_name),
                datasets: [
                    {
                        label: 'P50',
                        data: stepStatistics.map(s => s.percentiles[50] || 0),
                        backgroundColor: 'rgba(37, 99, 235, 0.6)'
                    },
                    {
                        label: 'P90',
                        data: stepStatistics.map(s => s.percentiles[90] || 0),
                        backgroundColor: 'rgba(16, 185, 129, 0.6)'
                    },
                    {
                        label: 'P95',
                        data: stepStatistics.map(s => s.percentiles[95] || 0),
                        backgroundColor: 'rgba(245, 158, 11, 0.6)'
                    },
                    {
                        label: 'P99',
                        data: stepStatistics.map(s => s.percentiles[99] || 0),
                        backgroundColor: 'rgba(239, 68, 68, 0.6)'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Response Time Percentiles by Step'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Response Time (ms)'
                        }
                    }
                }
            }
        });

        // Step Percentiles Chart - horizontal bar for better readability
        const stepPercentilesCtx = document.getElementById('stepPercentilesChart').getContext('2d');
        if (stepStatistics && stepStatistics.length > 0) {
            // Sort by P95 to show slowest steps first
            const sortedSteps = [...stepStatistics].sort((a, b) =>
                (b.percentiles[95] || 0) - (a.percentiles[95] || 0)
            ).slice(0, 8);

            new Chart(stepPercentilesCtx, {
                type: 'bar',
                data: {
                    labels: sortedSteps.map(s => s.step_name),
                    datasets: [
                        {
                            label: 'P50',
                            data: sortedSteps.map(s => s.percentiles[50] || 0),
                            backgroundColor: 'rgba(37, 99, 235, 0.7)'
                        },
                        {
                            label: 'P95',
                            data: sortedSteps.map(s => s.percentiles[95] || 0),
                            backgroundColor: 'rgba(245, 158, 11, 0.7)'
                        },
                        {
                            label: 'P99',
                            data: sortedSteps.map(s => s.percentiles[99] || 0),
                            backgroundColor: 'rgba(239, 68, 68, 0.7)'
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Response Time Percentiles (Slowest Steps)'
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Response Time (ms)'
                            }
                        }
                    }
                }
            });
        }

        // Step Throughput Chart
        const stepThroughputCtx = document.getElementById('stepThroughputChart').getContext('2d');
        if (stepStatistics && stepStatistics.length > 0) {
        new Chart(stepThroughputCtx, {
            type: 'doughnut',
            data: {
                labels: stepStatistics.map(s => s.step_name),
                datasets: [{
                    data: stepStatistics.map(s => s.total_requests),
                    backgroundColor: stepStatistics.map((_, index) =>
                        `hsl(${index * 137.5 % 360}, 70%, 50%)`
                    )
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Request Distribution by Step'
                    }
                }
            }
        });
        }

        let stepLinesChart;
        const stepResponseTimes = {{{stepResponseTimesData}}};
        const stepLinesCtx = document.getElementById('stepLinesChart').getContext('2d');

        function resetZoom() {
            if (stepLinesChart) {
                stepLinesChart.resetZoom();
            }
        }

        // Create datasets - one line per step with ALL individual response times
        // Use test start time from timeline data for fallback timestamps
        const testStartTime = timelineData.length > 0 ? new Date(timelineData[0].timestamp).getTime() : Date.now();

        const datasets = (stepResponseTimes || []).filter(step => step.response_times && step.response_times.length > 0).map((step, index) => {
            // Use timeline_data if available, otherwise create timestamps relative to test start
            const timelineDataPoints = step.timeline_data || step.response_times.map((responseTime, idx) => ({
                duration: responseTime,
                timestamp: testStartTime + (idx * 100), // 100ms intervals from test start
                vu_id: Math.floor(idx / 10) + 1,
                iteration: (idx % 10) + 1
            }));

            return {
                label: step.step_name,
                data: timelineDataPoints.map(point => ({
                    x: new Date(point.timestamp),
                    y: point.duration
                })),
                borderColor: `hsl(${index * 360 / Math.max(stepResponseTimes.length, 1)}, 70%, 50%)`,
                backgroundColor: `hsla(${index * 360 / Math.max(stepResponseTimes.length, 1)}, 70%, 50%, 0.1)`,
                fill: false,
                tension: 0,
                pointRadius: 2,
                pointHoverRadius: 4,
                borderWidth: 2,
                pointBackgroundColor: `hsl(${index * 360 / Math.max(stepResponseTimes.length, 1)}, 70%, 50%)`,
                pointBorderColor: `hsl(${index * 360 / Math.max(stepResponseTimes.length, 1)}, 70%, 40%)`
            };
        });

        if (datasets.length > 0) {
        stepLinesChart = new Chart(stepLinesCtx, {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Response Times by Step - All Individual Results'
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 6
                        }
                    },
                    tooltip: {
                        mode: 'point',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                const step = stepResponseTimes[context.datasetIndex];
                                const timelineData = step.timeline_data || [];
                                const dataPoint = timelineData[context.dataIndex];
                                
                                if (dataPoint) {
                                    return [
                                        `${step.step_name}: ${context.parsed.y}ms`,
                                        `VU: ${dataPoint.vu_id}`,
                                        `Iteration: ${dataPoint.iteration}`
                                    ];
                                } else {
                                    return `${step.step_name}: ${context.parsed.y}ms`;
                                }
                            },
                            title: function(context) {
                                return new Date(context[0].parsed.x).toLocaleTimeString();
                            }
                        }
                    },
                    zoom: {
                        limits: {
                            x: {min: 'original', max: 'original'},
                            y: {min: 0, max: 'original'}
                        },
                        pan: {
                            enabled: true,
                            mode: 'xy',
                            modifierKey: null,
                            threshold: 10
                        },
                        zoom: {
                            wheel: {
                                enabled: true,
                                speed: 0.1,
                                modifierKey: null
                            },
                            pinch: {
                                enabled: true
                            },
                            drag: {
                                enabled: true,
                                backgroundColor: 'rgba(37, 99, 235, 0.2)',
                                borderColor: 'rgba(37, 99, 235, 0.8)',
                                borderWidth: 2,
                                threshold: 10,
                                modifierKey: null
                            },
                            mode: 'xy'
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                second: 'HH:mm:ss',
                                minute: 'HH:mm'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Test Timeline'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Response Time (ms)'
                        }
                    }
                },
                interaction: {
                    mode: 'point',
                    intersect: false,
                },
                elements: {
                    point: {
                        hoverRadius: 6
                    }
                },
                animation: {
                    duration: 0 // Disable animation for better performance with many points
                }
            }
        });
        }

        // Performance Timeline Chart
        const performanceTimelineCtx = document.getElementById('performanceTimelineChart').getContext('2d');
        if (timelineData && timelineData.length > 0) {
        new Chart(performanceTimelineCtx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Active VUs',
                        data: timelineData.map(d => ({
                            x: new Date(d.timestamp),
                            y: d.active_vus || 0
                        })),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        yAxisID: 'y2',
                        tension: 0.1
                    },
                    {
                        label: 'Throughput (req/s)',
                        data: timelineData.map(d => ({
                            x: new Date(d.timestamp),
                            y: d.throughput
                        })),
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4
                    },
                    {
                        label: 'Avg Response Time',
                        data: timelineData.map(d => ({
                            x: new Date(d.timestamp),
                            y: d.avg_response_time
                        })),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Complete Performance Timeline'
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                second: 'HH:mm:ss'
                            }
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Throughput (req/s)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Response Time (ms)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        }
                    },
                    y2: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Active VUs'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        beginAtZero: true
                    }
                }
            }
        });
        }

        // Response Distribution Chart (in tab)
        const responseDistributionCtx = document.getElementById('responseDistributionChart').getContext('2d');

        // Calculate response time distribution
        const responseTimes = [];
        stepStatistics.forEach(step => {
            step.response_times.forEach(time => {
                responseTimes.push(time);
            });
        });

        // Create buckets for histogram with sensible sizing
        const distribution = [];
        if (responseTimes.length > 0) {
            const min = Math.min(...responseTimes);
            const max = Math.max(...responseTimes);
            const range = max - min;

            if (range < 1) {
                distribution.push({ bucket: `${Math.round(min)}ms`, count: responseTimes.length });
            } else {
                // Calculate ideal bucket size based on range
                const targetBuckets = 10;
                let bucketSize = range / targetBuckets;

                // Round to nice numbers
                if (bucketSize < 1) bucketSize = 1;
                else if (bucketSize < 2) bucketSize = 2;
                else if (bucketSize < 5) bucketSize = 5;
                else if (bucketSize < 10) bucketSize = 10;
                else if (bucketSize < 25) bucketSize = 25;
                else if (bucketSize < 50) bucketSize = 50;
                else if (bucketSize < 100) bucketSize = 100;
                else if (bucketSize < 250) bucketSize = 250;
                else if (bucketSize < 500) bucketSize = 500;
                else if (bucketSize < 1000) bucketSize = 1000;
                else bucketSize = Math.ceil(bucketSize / 1000) * 1000;

                const bucketStart = Math.floor(min / bucketSize) * bucketSize;
                const bucketEnd = Math.ceil(max / bucketSize) * bucketSize;
                const numBuckets = Math.max(1, Math.round((bucketEnd - bucketStart) / bucketSize));

                for (let i = 0; i < numBuckets; i++) {
                    const start = bucketStart + (i * bucketSize);
                    const end = start + bucketSize;
                    const count = responseTimes.filter(time =>
                        time >= start && (i === numBuckets - 1 ? time <= end : time < end)
                    ).length;

                    distribution.push({ bucket: `${Math.round(start)}-${Math.round(end)}ms`, count });
                }
            }
        }

        new Chart(responseDistributionCtx, {
            type: 'bar',
            data: {
                labels: distribution.map(d => d.bucket),
                datasets: [{
                    label: 'Request Count',
                    data: distribution.map(d => d.count),
                    backgroundColor: 'rgba(37, 99, 235, 0.6)',
                    borderColor: 'rgba(37, 99, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Response Time Distribution'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Requests'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Response Time Range'
                        }
                    }
                }
            }
        });

        // Core Web Vitals Chart
        {{#if summary.web_vitals_data}}
        const webVitalsCtx = document.getElementById('webVitalsChart')?.getContext('2d');
        if (webVitalsCtx) {
            const vitalsData = {
                labels: [],
                values: [],
                thresholds: [],
                colors: []
            };

            {{#if summary.web_vitals_data.lcp}}
            vitalsData.labels.push('LCP');
            vitalsData.values.push({{summary.web_vitals_data.lcp}});
            vitalsData.thresholds.push([2500, 4000]);
            vitalsData.colors.push('{{#ifEquals summary.vitals_details.lcp.score "good"}}#10b981{{else}}{{#ifEquals summary.vitals_details.lcp.score "needs-improvement"}}#f59e0b{{else}}#ef4444{{/ifEquals}}{{/ifEquals}}');
            {{/if}}

            {{#if summary.web_vitals_data.cls}}
            vitalsData.labels.push('CLS');
            vitalsData.values.push({{summary.web_vitals_data.cls}});
            vitalsData.thresholds.push([0.1, 0.25]);
            vitalsData.colors.push('{{#ifEquals summary.vitals_details.cls.score "good"}}#10b981{{else}}{{#ifEquals summary.vitals_details.cls.score "needs-improvement"}}#f59e0b{{else}}#ef4444{{/ifEquals}}{{/ifEquals}}');
            {{/if}}

            {{#if summary.web_vitals_data.inp}}
            vitalsData.labels.push('INP');
            vitalsData.values.push({{summary.web_vitals_data.inp}});
            vitalsData.thresholds.push([200, 500]);
            vitalsData.colors.push('{{#ifEquals summary.vitals_details.inp.score "good"}}#10b981{{else}}{{#ifEquals summary.vitals_details.inp.score "needs-improvement"}}#f59e0b{{else}}#ef4444{{/ifEquals}}{{/ifEquals}}');
            {{/if}}

            {{#if summary.web_vitals_data.fid}}
            vitalsData.labels.push('FID (deprecated)');
            vitalsData.values.push({{summary.web_vitals_data.fid}});
            vitalsData.thresholds.push([100, 300]);
            vitalsData.colors.push('{{#ifEquals summary.vitals_details.fid.score "good"}}#10b981{{else}}{{#ifEquals summary.vitals_details.fid.score "needs-improvement"}}#f59e0b{{else}}#ef4444{{/ifEquals}}{{/ifEquals}}');
            {{/if}}

            {{#if summary.web_vitals_data.fcp}}
            vitalsData.labels.push('FCP');
            vitalsData.values.push({{summary.web_vitals_data.fcp}});
            vitalsData.thresholds.push([1800, 3000]);
            vitalsData.colors.push('{{#ifEquals summary.vitals_details.fcp.score "good"}}#10b981{{else}}{{#ifEquals summary.vitals_details.fcp.score "needs-improvement"}}#f59e0b{{else}}#ef4444{{/ifEquals}}{{/ifEquals}}');
            {{/if}}

            {{#if summary.web_vitals_data.ttfb}}
            vitalsData.labels.push('TTFB');
            vitalsData.values.push({{summary.web_vitals_data.ttfb}});
            vitalsData.thresholds.push([800, 1800]);
            vitalsData.colors.push('{{#ifEquals summary.vitals_details.ttfb.score "good"}}#10b981{{else}}{{#ifEquals summary.vitals_details.ttfb.score "needs-improvement"}}#f59e0b{{else}}#ef4444{{/ifEquals}}{{/ifEquals}}');
            {{/if}}

            new Chart(webVitalsCtx, {
                type: 'bar',
                data: {
                    labels: vitalsData.labels,
                    datasets: [{
                        label: 'Measured Value',
                        data: vitalsData.values,
                        backgroundColor: vitalsData.colors,
                        borderColor: vitalsData.colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Core Web Vitals Performance',
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const thresholds = vitalsData.thresholds[context.dataIndex];
                                    if (thresholds) {
                                        return [
                                            `Good: â‰¤ ${thresholds[0]}${context.label === 'CLS' ? '' : 'ms'}`,
                                            `Poor: > ${thresholds[1]}${context.label === 'CLS' ? '' : 'ms'}`
                                        ];
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value (ms / ratio)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Core Web Vitals Metrics'
                            }
                        }
                    }
                }
            });
        }
        {{/if}}
        
        // Enhanced Web Vitals Charts for Playwright Tests
        {{#if webVitalsCharts}}
        // Score Distribution Pie Chart
        const scoreCtx = document.getElementById('webVitalsScoreChart')?.getContext('2d');
        if (scoreCtx) {
            new Chart(scoreCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Good', 'Needs Improvement', 'Poor'],
                    datasets: [{
                        data: [
                            {{webVitalsCharts.scoreDistribution.good}},
                            {{webVitalsCharts.scoreDistribution.needsImprovement}},
                            {{webVitalsCharts.scoreDistribution.poor}}
                        ],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        // Combined Web Vitals Timeline Chart
        const webVitalsTimelineCtx = document.getElementById('webVitalsTimelineChart')?.getContext('2d');
        const webVitalsTimeSeries = {{{json webVitalsCharts.timeSeries}}};
        if (webVitalsTimelineCtx && webVitalsTimeSeries && webVitalsTimeSeries.unified) {
            const timeSeries = webVitalsTimeSeries;
            const unifiedData = timeSeries.unified;
            const metrics = ['lcp', 'cls', 'inp', 'ttfb', 'fcp', 'fid'];
            const metricsConfig = {
                lcp: { label: 'LCP', color: '#FF6B6B', yAxisID: 'y' },
                cls: { label: 'CLS', color: '#45B7D1', yAxisID: 'y1' },
                inp: { label: 'INP', color: '#4ECDC4', yAxisID: 'y' },
                ttfb: { label: 'TTFB', color: '#FECA57', yAxisID: 'y' },
                fcp: { label: 'FCP', color: '#96CEB4', yAxisID: 'y' },
                fid: { label: 'FID', color: '#9370DB', yAxisID: 'y' }
            };
            
            // Create datasets for available metrics using unified data
            const datasets = [];
            metrics.forEach(metric => {
                if (unifiedData.data[metric] && unifiedData.data[metric].some(v => v !== null)) {
                    const config = metricsConfig[metric];
                    datasets.push({
                        label: config.label,
                        data: unifiedData.data[metric],
                        borderColor: config.color,
                        backgroundColor: config.color + '20',
                        tension: 0.1,
                        yAxisID: config.yAxisID,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        spanGaps: true // Connect lines across null values
                    });
                }
            });
            
            const labels = unifiedData.labels;
            
            new Chart(webVitalsTimelineCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 6
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const metric = context.dataset.label.toLowerCase();
                                    const value = context.parsed.y;
                                    if (metric === 'cls') {
                                        return `${context.dataset.label}: ${value.toFixed(3)}`;
                                    } else if (value < 1000) {
                                        return `${context.dataset.label}: ${Math.round(value)}ms`;
                                    } else {
                                        return `${context.dataset.label}: ${(value / 1000).toFixed(2)}s`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Time (ms)'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'CLS Score'
                            },
                            max: 1,
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }
        
        // Time Series Charts for Each Metric
        {{#each webVitalsCharts.metrics}}
        const {{this}}Ctx = document.getElementById('webVitals{{this}}Chart')?.getContext('2d');
        if ({{this}}Ctx && webVitalsTimeSeries.{{this}}) {
            const timeSeriesData = webVitalsTimeSeries.{{this}};
            new Chart({{this}}Ctx, {
                type: 'line',
                data: {
                    labels: timeSeriesData.labels,
                    datasets: [{
                        label: '{{this}}',
                        data: timeSeriesData.data,
                        borderColor: timeSeriesData.borderColor,
                        backgroundColor: timeSeriesData.backgroundColor + '20',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '{{#ifEquals this "cls"}}Score{{else}}ms{{/ifEquals}}'
                            }
                        }
                    }
                }
            });
        }
        {{/each}}
        
        // Percentiles Chart
        const percentilesCtx = document.getElementById('webVitalsPercentilesChart')?.getContext('2d');
        const webVitalsDistributions = {{{json webVitalsCharts.distributions}}};
        if (percentilesCtx && webVitalsDistributions) {
            const distributions = webVitalsDistributions;
            const metrics = Object.keys(distributions);
            const datasets = [
                {
                    label: 'P50 (Median)',
                    data: metrics.map(m => distributions[m]?.median || 0),
                    backgroundColor: '#4ECDC4'
                },
                {
                    label: 'P75',
                    data: metrics.map(m => distributions[m]?.p75 || 0),
                    backgroundColor: '#45B7D1'
                },
                {
                    label: 'P90',
                    data: metrics.map(m => distributions[m]?.p90 || 0),
                    backgroundColor: '#FECA57'
                },
                {
                    label: 'P95',
                    data: metrics.map(m => distributions[m]?.p95 || 0),
                    backgroundColor: '#FF6B6B'
                },
                {
                    label: 'P99',
                    data: metrics.map(m => distributions[m]?.p99 || 0),
                    backgroundColor: '#C44569'
                }
            ];
            
            new Chart(percentilesCtx, {
                type: 'bar',
                data: {
                    labels: metrics.map(m => m.toUpperCase()),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: {
                            display: true,
                            text: 'Web Vitals Percentile Distribution'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            type: 'logarithmic',
                            title: {
                                display: true,
                                text: 'Value (log scale)'
                            }
                        }
                    }
                }
            });
        }
        {{/if}}

        // Verification Performance Chart
        {{#if summary.verification_metrics}}
        const verificationCtx = document.getElementById('verificationChart')?.getContext('2d');
        if (verificationCtx && {{{json results}}}) {
            const verificationData = {{{json results}}}.filter(r => r.custom_metrics?.verification_metrics)
                .map(r => ({
                    timestamp: r.timestamp,
                    duration: r.custom_metrics.verification_metrics.duration,
                    success: r.custom_metrics.verification_metrics.success,
                    stepName: r.custom_metrics.verification_metrics.step_name || 'Unknown'
                }));

            new Chart(verificationCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Successful Verifications',
                        data: verificationData.filter(d => d.success).map(d => ({
                            x: new Date(d.timestamp),
                            y: d.duration
                        })),
                        backgroundColor: '#10b981',
                        borderColor: '#10b981',
                        pointRadius: 6
                    }, {
                        label: 'Failed Verifications',
                        data: verificationData.filter(d => !d.success).map(d => ({
                            x: new Date(d.timestamp),
                            y: d.duration
                        })),
                        backgroundColor: '#ef4444',
                        borderColor: '#ef4444',
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Verification Step Performance Over Time',
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].parsed.x).toLocaleTimeString();
                                },
                                label: function(context) {
                                    const datasetIndex = context.datasetIndex;
                                    const dataIndex = context.dataIndex;
                                    const filtered = datasetIndex === 0
                                        ? verificationData.filter(d => d.success)
                                        : verificationData.filter(d => !d.success);
                                    const point = filtered[dataIndex];
                                    return [
                                        `Duration: ${Math.round(context.parsed.y)}ms`,
                                        `Step: ${point?.stepName || 'Unknown'}`,
                                        `Status: ${point?.success ? 'Success' : 'Failed'}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            position: 'bottom',
                            time: {
                                displayFormats: {
                                    second: 'HH:mm:ss',
                                    minute: 'HH:mm',
                                    hour: 'HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Duration (ms)'
                            }
                        }
                    }
                }
            });
        }
        {{/if}}

        // Connect Time Over Time Chart - only show if there's meaningful data
        const hasConnectTimeData = connectTimeData && connectTimeData.length > 0 &&
            connectTimeData.some(d => d.avg_connect_time > 0);
        if (hasConnectTimeData) {
            const connectTimeCtx = document.getElementById('connectTimeChart').getContext('2d');
            new Chart(connectTimeCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Avg Connect Time (ms)',
                        data: connectTimeData.map(d => ({
                            x: d.timestamp,
                            y: d.avg_connect_time
                        })),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'TCP Connection Time Over Time',
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].parsed.x).toLocaleTimeString();
                                },
                                label: function(context) {
                                    return `Connect Time: ${Math.round(context.parsed.y)}ms`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    second: 'HH:mm:ss'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Connect Time (ms)'
                            }
                        }
                    }
                }
            });
        } else {
            // Hide connect time chart container if no data
            const connectTimeContainer = document.getElementById('connectTimeChart')?.closest('.chart-container, .bg-white, [class*="rounded"]');
            if (connectTimeContainer) connectTimeContainer.style.display = 'none';
        }

        // Latency Over Time Chart - only show if there's meaningful data
        const hasLatencyData = latencyData && latencyData.length > 0 &&
            latencyData.some(d => d.avg_latency > 0);
        if (hasLatencyData) {
            const latencyCtx = document.getElementById('latencyChart').getContext('2d');
            new Chart(latencyCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Avg Latency / TTFB (ms)',
                        data: latencyData.map(d => ({
                            x: d.timestamp,
                            y: d.avg_latency
                        })),
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Latency (Time to First Byte) Over Time',
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].parsed.x).toLocaleTimeString();
                                },
                                label: function(context) {
                                    return `Latency: ${Math.round(context.parsed.y)}ms`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    second: 'HH:mm:ss'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Latency (ms)'
                            }
                        }
                    }
                }
            });
        } else {
            // Hide latency chart container if no data
            const latencyContainer = document.getElementById('latencyChart')?.closest('.chart-container, .bg-white, [class*="rounded"]');
            if (latencyContainer) latencyContainer.style.display = 'none';
        }
    </script>
</body>

</html>